<template>
    <q-card class="q-mb-lg shadow-12 rounded-card row items-end">
      <q-card-section class="col-12">
            <!-- :src="`${url}/productos/${product.image}`" -->
            <q-card-section class="row reverse q-gutter-x-lg">
              <svg
                  class="col-3"
                  xmlns="http://www.w3.org/2000/svg"
                  id="logo"
                  width="192.505"
                  height="80.027"
                  viewBox="0 0 192.505 80.027"
                >
                    <g id="LOGO">
                      <g id="Raggruppa_420" data-name="Raggruppa 420" transform="translate(-7.947 -2.761)">
                        <g id="Raggruppa_55" data-name="Raggruppa 55" transform="translate(7.947 2.761)">
                          <path id="Tracciato_74" data-name="Tracciato 74" d="M2.834,0l-.05-.017L-28.067,35.338-11.7,41.126,1.346,45.738-8.991,33.464ZM80.169,35.377H55.14v-24.9h-5.7V41.041H80.169ZM102.975,16.14h25.031V10.476H97.271V41.041h5.7V28.553H122.3V22.89h-19.33Zm-11.4-5.663h-5.7V40.965h5.7Zm72.868,5.663V10.476H133.705V41.041h30.733V35.377h-25.03V28.553h19.33V22.89h-19.33V16.14ZM112.9,62.325l2.307-6.147,2.308,6.147Zm1.718-7.088-4.632,11.707h1.145l1.392-3.676h5.37l1.358,3.676H120.4l-4.517-11.707Zm-10.143,5.316a4.8,4.8,0,0,1-1.154.131H99.853V56.178h3.534a5.8,5.8,0,0,1,1.073.1,2.74,2.74,0,0,1,.916.341,1.794,1.794,0,0,1,.639.667,2.172,2.172,0,0,1,.238,1.074,2.257,2.257,0,0,1-.23,1.057,2.029,2.029,0,0,1-.621.723,2.582,2.582,0,0,1-.926.415m2.776,6.042a1.675,1.675,0,0,1-.139-.43,6.778,6.778,0,0,1-.1-.716c-.029-.293-.046-.661-.058-1.106-.012-.3-.03-.619-.057-.944a3.9,3.9,0,0,0-.189-.926,2.277,2.277,0,0,0-.441-.781,1.835,1.835,0,0,0-.818-.52,3.436,3.436,0,0,0,1.467-1.106,3.045,3.045,0,0,0,.449-1.757,2.666,2.666,0,0,0-1.031-2.349,5.155,5.155,0,0,0-2.98-.723H98.74V66.927l1.113.016V61.625h3.5a6.246,6.246,0,0,1,.794.05,2.276,2.276,0,0,1,.7.195,1.443,1.443,0,0,1,.532.43,1.847,1.847,0,0,1,.319.757,6.494,6.494,0,0,1,.09.878c.017.357.037.726.065,1.106s.066.743.114,1.089a2.148,2.148,0,0,0,.254.814l1.228-.016v-.1a.652.652,0,0,1-.2-.235M89.636,61.837h3.978a8.252,8.252,0,0,1-.123,1.268,4.1,4.1,0,0,1-.383,1.156,3.6,3.6,0,0,1-.7.958,3.732,3.732,0,0,1-.884.634,3.862,3.862,0,0,1-.982.351,4.839,4.839,0,0,1-.983.105,3.95,3.95,0,0,1-3.15-1.447,4.714,4.714,0,0,1-.836-1.545,5.982,5.982,0,0,1-.285-1.853,9.541,9.541,0,0,1,.253-2.269,4.99,4.99,0,0,1,.794-1.772A3.674,3.674,0,0,1,87.7,56.275a4.547,4.547,0,0,1,2-.406,4.194,4.194,0,0,1,1.26.187,3.792,3.792,0,0,1,1.1.537,3.4,3.4,0,0,1,1.341,2.04h1.146A4.855,4.855,0,0,0,93.909,57a4.166,4.166,0,0,0-1.09-1.155,4.62,4.62,0,0,0-1.457-.691,6.448,6.448,0,0,0-1.743-.227,5.734,5.734,0,0,0-2.414.471,4.782,4.782,0,0,0-1.7,1.293A5.362,5.362,0,0,0,84.5,58.626a8.433,8.433,0,0,0-.329,2.4,8.8,8.8,0,0,0,.384,2.733A5.45,5.45,0,0,0,85.626,65.7a4.4,4.4,0,0,0,1.636,1.163,5.377,5.377,0,0,0,2.062.39,6.723,6.723,0,0,0,1.556-.163,4.567,4.567,0,0,0,1.212-.463,3.944,3.944,0,0,0,.925-.733,5.53,5.53,0,0,0,.711-.95v2h.95V60.894H89.636Zm44.63,5.107h1.113V55.236h-1.113Zm27.751-1.481h-.034l-6.81-10.226h-1.261V66.943h1.113V56.731h.034l6.775,10.212h1.294V55.236h-1.112ZM74.346,61.349H80.42v-.943H74.346V56.178h6.728v-.942H73.232V66.943h8.005V66H74.346Zm47.969-5.171h3.732V66.943h1.112V56.178h3.733v-.942h-8.578Zm26.661,6.895a4.839,4.839,0,0,1-.786,1.659,3.959,3.959,0,0,1-1.359,1.146,4.207,4.207,0,0,1-1.972.431,4.3,4.3,0,0,1-1.988-.423,3.828,3.828,0,0,1-1.359-1.139,4.794,4.794,0,0,1-.786-1.658,7.835,7.835,0,0,1,0-3.952,4.915,4.915,0,0,1,.786-1.667,3.96,3.96,0,0,1,1.359-1.163,4.1,4.1,0,0,1,1.955-.439,4.508,4.508,0,0,1,1.832.358,3.753,3.753,0,0,1,1.394,1.041,4.734,4.734,0,0,1,.874,1.65,7.288,7.288,0,0,1,.3,2.186,7.569,7.569,0,0,1-.253,1.968m-.033-6.35a4.873,4.873,0,0,0-1.734-1.317,5.7,5.7,0,0,0-2.416-.48,5.345,5.345,0,0,0-2.341.488,4.952,4.952,0,0,0-1.7,1.326,5.79,5.79,0,0,0-1.039,1.959,8.429,8.429,0,0,0-.008,4.789,5.644,5.644,0,0,0,1.031,1.951,4.9,4.9,0,0,0,1.719,1.326,6.1,6.1,0,0,0,4.779,0,4.892,4.892,0,0,0,1.719-1.326,5.757,5.757,0,0,0,1.04-1.951,7.829,7.829,0,0,0,.352-2.382,8.05,8.05,0,0,0-.352-2.415,5.7,5.7,0,0,0-1.048-1.968m-87.269-.545h3.732V66.943H66.52V56.178h3.732v-.942H61.674ZM21.851,64.442l-2.145-9.2H16.123v11.7h2.294V59.027q0-.341-.009-.957c0-.41-.008-.726-.008-.948l2.217,9.822H23.01l2.234-9.822q0,.333-.009.948t-.008.957v7.916h2.294v-11.7H23.979ZM33.67,61.829h5.724V59.8H33.67V57.311H39.9V55.239H31.265v11.7h8.927v-2.1H33.67ZM-4.167,59.7h-4.58V55.239h-2.446v11.7h2.446V61.719h4.58v5.225h2.445v-11.7H-4.167ZM9.571,64.125A2.821,2.821,0,0,1,7.249,65.2a2.853,2.853,0,0,1-2.334-1.072,5.768,5.768,0,0,1,0-6.1,2.851,2.851,0,0,1,2.334-1.073,2.819,2.819,0,0,1,2.322,1.076,5.831,5.831,0,0,1,0,6.1M7.249,54.882a5.16,5.16,0,0,0-3.861,1.365A6.172,6.172,0,0,0,1.6,61.076,6.291,6.291,0,0,0,3.388,65.9a5.16,5.16,0,0,0,3.861,1.365A5.162,5.162,0,0,0,11.11,65.9a6.311,6.311,0,0,0,1.781-4.828,6.191,6.191,0,0,0-1.781-4.829,5.162,5.162,0,0,0-3.861-1.365M43.976,66.943h1.112V55.236H43.976ZM57.6,65.462h-.033L50.755,55.236H49.494V66.943h1.113V56.731h.032l6.777,10.212h1.294V55.236H57.6ZM12.21.079l10.4,12.347L10.719,46.061l.051.02L41.621,10.726,28.568,6.11ZM.753,23.031A6.023,6.023,0,1,0,6.778,17.05,6.005,6.005,0,0,0,.753,23.031" transform="translate(28.067 0.016)" fill="#000"></path>
                        </g>
                      </g>
                    </g>
                    <path id="Tracciato_148" data-name="Tracciato 148" d="M-8227.488,9763.788h58.435" transform="translate(8244.053 -9685.761)" fill="none" stroke="#226922" stroke-width="4"></path>
                    <path id="Tracciato_149" data-name="Tracciato 149" d="M-8227.488,9763.788h58.435" transform="translate(8302.489 -9685.761)" fill="none" stroke="#fff" stroke-width="4"></path>
                    <path id="Tracciato_150" data-name="Tracciato 150" d="M-8227.488,9763.788h58.435" transform="translate(8360.923 -9685.761)" fill="none" stroke="#b40000" stroke-width="4"></path>
            </svg>
              <q-img
                class="col q-mb-md"
                style="border-radius: 26px"
                folder="productos"
                :src="`${url}/productos/${product.imagen}.png`"
              >
                <template #error>
                    <q-img
                      class="col-auto"
                      style="border-radius: 26px; border: 1px solid rgba(#455a64, 10)"
                      src="../assets/logo.jpg"
                      width="170px"
                      height="100px"
                    />
                </template>
              </q-img>
            </q-card-section>
          <div class="text-bold col full-height flex">
            <div class="text-h5 text-blue-grey-10">
              {{ product.name }}
            </div>
            <a
              target="_blank"
              href="https://www.homelife.it/es/producto/vis"
              class="text-info cursor-pointer col-auto text-caption q-mt-auto q-ml-auto"
              :class="$q.screen.width < 768 ? '' : ''"
            >
              Mas información
            </a>
          </div>
          <q-separator size="1px" spaced="10px" />
          <div class="col-12">
            <div class="row q-col-gutter-y-md">
                  <div class="description text-lowercase text-blue-grey-13 col-12">
                    {{ product.description }}
                  </div>
                  <div v-if="product.accessories" class="col-12 text-blue-grey-10 text-bold">
                    Incluye:
                  </div>
                  <div class="col-auto text-blue-grey-13 capitalize-first">
                    {{ product.accessories?.toLowerCase() }}
                  </div>
                </div>
            </div>
        <q-separator size="1px" spaced="5px" />
      </q-card-section>
      <q-card-actions class="col-12 items-end no-padding text-no-wrap">
        <ProductQuantity
          :product="state"
          @update-item="(e) => (e === '+' ? increase() : decrease())"
        >
          <template #extraInfo>
            <div
              v-if="product.stock < 20"
              class="text-accent q-my-auto  col text-right text-accent"
            >
              {{  product.stock === 1 ?  `Queda ${product.stock} ud.` :  `Quedan ${product.stock} uds.`}}
            </div>
          </template>
        </ProductQuantity>
      </q-card-actions>
      <q-card-actions class="row justify-between full-width q-pa-md">
        <action-button
          @click="addToCart(); bus.emit('product-to-cart', countItemElement)"
          :label="$q.screen.width < 300 ? 'Añadir' : 'Al carrito'"
          neutro
          class="transition-slow col"
        >
          <template #icon>
            <q-icon
              v-if="$q.screen.width > 315"
              size="20px"
              name="mdi-cart-plus"
              color="blue-grey-14"
              class="q-ml-sm"
            />
          </template>
          <template #badge>
            <div
              v-if="Number(itemsAdded) > 0"
              ref="countItemElement"
              :key="itemsAdded"
              class="product-count"
            >
              {{ itemsAdded }}
            </div>
          </template>
        </action-button>
        <action-button
          @click="addToCart(); toggleCartDialog()"
          class="transition-slow col"
          label="Pagar"
          style="min-width: 130.8px"
        />
      </q-card-actions>
    </q-card>
</template>

<script lang="ts">
import { defineComponent, ref, computed, inject, Ref } from 'vue'

import ProductQuantity from 'components/ProductQuantity.vue'
import useCartDialog from '../composables/useCartDialog'
import useCartAnimation from 'src/composables/useCartAnimation'
import { EventBus } from 'quasar'
import useProductCart from '../composables/useProductCart'
import { Product } from './models'

export default defineComponent({
  name: 'ProductComponent',
  components: {
    ProductQuantity,
  },
  props: {
    product: {
      type: Object as () => Product,
      default: () => ({ id: 0, name: '', price: 0, quantity: 0 })
    }
  },
  emits: ['product-to-cart'],
  setup(props) {
    const { cart, increase, decrease, state, addToCart } = useProductCart(props.product)
    const { toggle, loading } = useCartAnimation()
    const { toggleCartDialog } = useCartDialog()
    const countItemElement: Ref<HTMLDivElement | null> = ref(null)
    const bus = inject<EventBus>('bus', new EventBus())
    const morphGroupModel = ref('topleft')

    return {
      bus,
      increase,
      decrease,
      addToCart,
      state,
      useProductCart,
      toggle,
      itemsAdded: computed(
        () =>
          `${cart.value.reduce(
            (acc, crr) =>
              (acc += crr.id === props.product.id ? crr.quantity : 0),
            0
          )}`
      ),
      checkIsAdded: computed(() =>
        cart.value.some((p: Product) => p.id === props.product.id)
      ),
      url: process.env.IMAGES_URL,
      loading,
      morphGroupModel,
      countItemElement,
      toggleCartDialog,
    }
  },
})
</script>

<style lang="scss" scoped>
.product-count {
  background-color: $light-blue-11 !important;
  color: #fff;
  font-size: 14px;
  font-family: 'Knockout';
  border-radius: 28px;
  line-height: 30px;
  height: 30px;
  width: 30px;
  top: -6px;
  right: -6px;
  position: absolute !important;
}
.transition-slow {
  transition-property: all;
  transition-duration: 2s;
}
.mdi-cart-outline {
  margin-right: 10px;
}
.description::first-letter {
  text-transform: uppercase;
}
</style>
